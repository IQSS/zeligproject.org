#!/bin/sh
# This script should be run with the a wrapper script enabling Python 2.7
echo "Building docs and copying them into place"
# FIXME: "No module named virtualenvwrapper"
#source /opt/rh/python27/root/usr/bin/virtualenvwrapper.sh
source /webapps/code/zeligproject.org/deploy/workon-docs.zeliproject.org
echo "Install virtualenvwrapper"
pip install sphinxcontrib-programoutput

cd /webapps/code/docs.zeligproject.org/doc
git status
git pull
# FIXME: remove all plain .rst and generated .png files from git
rm -f source/installation_quickstart.rst
rm -f `find source | grep 'source/zelig-.*\.rst$'`
# FIXME: Are any PNG files *not* generated by Sphinx/knitr?
rm -f `find source | grep 'source/.*\.png$'`
#rm -f /webapps/code/docs.zeligproject.org/doc/source/figure/Scatterplot.png
#rm -f /webapps/code/docs.zeligproject.org/doc/source/figure/Scatterplot-1.png
#rm -f /webapps/code/docs.zeligproject.org/doc/source/_images/Scatterplot.png
#rm -f /webapps/code/docs.zeligproject.org/doc/source/_images/Scatterplot-1.png
git status
# FIXME: don't need knitquickstart.R (remove from docs repo)
#Rscript source/knitquickstart.R
Rscript source/knitall.R
make clean
make html
make latexpdf
# expected (for now) that files changes, sampling?
# FIXME: put this in en/latest
rsync -auv --delete --checksum build/html/  /opt/rh/httpd24/root/var/www/docs.zeligproject.org/en/latest
cp /webapps/code/docs.zeligproject.org/doc/build/latex/Zelig.pdf /opt/rh/httpd24/root/var/www/docs.zeligproject.org/en/latest
